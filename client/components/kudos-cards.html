<link rel="import" href="../bower_components/star-rating/star-rating.html">
<dom-module id="kudos-cards">
  <link rel="import" href="../css/kudo-style.html">
  <template>
    <style include="cards"></style>
    <style include="kudos"></style>
    <!-- Bienvenida -->
    <div style="display:table">
      <img id="imgProfile" class="avatar" src="{{userPicture}}">
      <div style="display:table-cell;vertical-align:middle"> ¡Welcome {{userFirstName}}!</div>
    </div>
    <!-- Lista de Bloques -->
    <template id="arrBlocks" is="dom-repeat" items="{{blocks}}" as="block">
      <paper-card style="width:95%">
        <div>
          <div class="rate-header titleProject" style$="height:70px;background:{{block.color}}" on-click="unCollapse" data-args$="[[block.id]]">
            <div class="display_inline"><img style="width:80%" src="[[block.img]]"></div>
            <div class="display_inline" style="top: 40%;transform: translateY(-60%);">&gt; {{block.title}}</div>
          <!--<paper-icon-button icon="icons:arrow-drop-down" style="float:right;"></paper-icon-button></div>-->
        </div>
        <iron-collapse id="clp_[[block.id]]" style="width:100%;">
          <!-- Lista de Tarjetas x Bloque -->
          <template id="arrCards" is="dom-repeat" items="{{_getCards(block)}}" as="card">
            <paper-card class="rate">
              <div class="rate-content">
                <div>
                  <div class="rate-header titleProject" style$="background:{{card.color}}">
                    {{card.title}}
                  </div>
                  <div class="rate-name">
                    <div class="div_middle">
                      <div><b>Description:</b> {{card.description}}</div>
                      <template is="dom-if" if="{{card.sdacode}}">
                        <div><b>SDACODE:</b> {{card.sdacode}}</div>
                      </template>
                      <template is="dom-if" if="{{card.kpi}}">
                        <div><b>Meta:</b> {{card.kpi}}</div>
                      </template>
                      <template is="dom-if" if="{{card.mvp}}">
                        <div><b>MVP:</b> {{card.mvp}}</div>
                      </template>
                      <div><a href="[[card.linkValue]]" target="_blank">[[card.linkLabel]]</a></div>
                      <!--elvis-->
                      <template is="dom-if" if="{{withFeedback}}">
                        <div>
                          <paper-button on-click="_getComments" data='{{card}}'>View comments</paper-button>
                        </div>
                      </template>
                    </div>
                    <div class="div_feedback">
                      <paper-button class="rate-icon bot" id="{{card.id}}" data='{{card}}' on-click="openBot" style$="display:[[card.withChat]]">
                        Chatbot<iron-icon icon="communication:live-help" data='{{card}}'></iron-icon>
                      </paper-button>
                      <template is="dom-if" if="{{withFeedback}}">
                        <paper-button class="rate-icon feeback" id="{{card.id}}" data='{{card}}' on-click="openModal">
                          Feedback <iron-icon icon="announcement" data='{{card}}'></iron-icon>
                        </paper-button>
                      </template>
                    </div>
                  </div>
                </div>
                <div class="card-actions kudos-button">
                  <template is="dom-if" if="{{withKudos}}">
                    <template id="tmtKudo" is="dom-repeat" items="{{kudos}}" as="kudo">
                      {{getKudosUser(card.block,card.id,kudo.id)}}
                      <paper-button class$="kudo [[kudo.id]]" toggles  id="id_{{card.id}}_{{kudo.id}}" on-click="_assess">
                        <!--<iron-icon icon="{{kudo.icon}}"></iron-icon> -->
                        <img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTEuOTk5IDUxMS45OTkiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMS45OTkgNTExLjk5OTsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHdpZHRoPSIyNHB4IiBoZWlnaHQ9IjI0cHgiPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik00NjYuNDUsNDkuMzc0Yy03LjA2NS04LjMwOC0xNy4zNjgtMTMuMDcxLTI4LjI2Ny0xMy4wNzFINDAyLjQxdi0xMS4xOUM0MDIuNDEsMTEuMjY2LDM5MS4xNDMsMCwzNzcuMjk3LDBIMTM0LjcwNSAgICBjLTEzLjg0OCwwLTI1LjExMiwxMS4yNjYtMjUuMTEyLDI1LjExMnYxMS4xOUg3My44MTZjLTEwLjg5OSwwLTIxLjIwMyw0Ljc2NC0yOC4yNjcsMTMuMDcxICAgIGMtNi45OTIsOC4yMjEtMTAuMDE0LDE5LjAxOS04LjI4OSwyOS42MjRjOS40LDU3LjgsNDUuNzc1LDEwOC44NjMsOTcuNCwxMzYuODcyYzQuNzE3LDExLjM0MSwxMC4wNTksMjIuMDgzLDE2LjAwOCwzMi4wOTEgICAgYzE5LjAwMiwzMS45NzUsNDIuNjI1LDU0LjA3Myw2OC42MjcsNjQuNzZjMi42MzUsMjYuNjQ0LTE1LjA5NCw1MS44ODUtNDEuNzk0LDU3LjljLTAuMDU3LDAuMDEzLTAuMDk3LDAuMDMzLTAuMTUzLDAuMDQ2ICAgIGMtNS4yMTEsMS4yNDUtOS4wOSw1LjkyMS05LjA5LDExLjUxM3Y1NC4zNjNoLTIxLjk4NmMtMTkuNjAyLDAtMzUuNTQ5LDE1Ljk0Ny0zNS41NDksMzUuNTQ5djI4LjA1OCAgICBjMCw2LjU0NSw1LjMwNSwxMS44NSwxMS44NSwxMS44NUgzOTAuNTZjNi41NDUsMCwxMS44NS01LjMwNSwxMS44NS0xMS44NXYtMjguMDU4YzAtMTkuNjAyLTE1Ljk0Ny0zNS41NDktMzUuNTQ5LTM1LjU0OWgtMjEuOTg4ICAgIFYzODIuMThjMC01LjYwMy0zLjg5My0xMC4yODYtOS4xMTgtMTEuNTJjLTAuMDQ5LTAuMDEyLTAuMDk2LTAuMDI4LTAuMTQ1LTAuMDRjLTI2LjkwMi02LjA1NS00NC42NjQtMzEuNTUtNDEuNzUyLTU4LjM5NCAgICBjMjUuNTQ4LTEwLjg2LDQ4Ljc1Ny0zMi43NjEsNjcuNDc5LTY0LjI2NGM1Ljk0OS0xMC4wMDksMTEuMjktMjAuNzUyLDE2LjAwOC0zMi4wOTVjNTEuNjIyLTI4LjAxLDg3Ljk5NS03OS4wNzIsOTcuMzk1LTEzNi44NyAgICBDNDc2LjQ2NSw2OC4zOTIsNDczLjQ0Myw1Ny41OTUsNDY2LjQ1LDQ5LjM3NHogTTYwLjY1Miw3NS4xOTJjLTAuNjE2LTMuNzg3LDAuNDMxLTcuNTA0LDIuOTQ5LTEwLjQ2NiAgICBjMi41NTUtMy4wMDQsNi4yNzctNC43MjYsMTAuMjE0LTQuNzI2aDM1Ljc3N3YyMS44MDJjMCwzNC4xODYsNC4zNjMsNjcuMywxMi42MzIsOTcuNTgzICAgIEM4OS43MjgsMTUzLjcwNiw2Ny4zNTQsMTE2LjQwMyw2MC42NTIsNzUuMTkyeiBNMzY2Ljg2MSw0NjAuMjQzYzYuNTM0LDAsMTEuODUsNS4zMTYsMTEuODUsMTEuODV2MTYuMjA4SDEzNC40MjJ2LTE2LjIwOCAgICBjMC02LjUzNCw1LjMxNi0xMS44NSwxMS44NS0xMS44NUgzNjYuODYxeiBNMzIxLjE3MywzOTQuMDN2NDIuNTEzSDE5MS45NlYzOTQuMDNIMzIxLjE3M3ogTTIyMy4wMzcsMzcwLjMzMSAgICBjMi45MjktMy4yMjQsNS42MDctNi43MTksOC4wMDItMTAuNDZjNy44OTctMTIuMzM5LDEyLjA0Mi0yNi4zNTcsMTIuMjI4LTQwLjY3NGM0LjIwOSwwLjU3Myw4LjQ1NywwLjg4LDEyLjc0MSwwLjg4ICAgIGM0LjY2MSwwLDkuMjc5LTAuMzU4LDEzLjg1Mi0xLjAzNmMwLjI3LDE5LjIzOSw3Ljc1OCwzNy40NSwyMC4zNDksNTEuMjg5SDIyMy4wMzd6IE0zNzguNzA5LDgxLjgwMyAgICBjMCw1OC4zNzktMTMuNDA2LDExMy4wODktMzcuNzQ3LDE1NC4wNDljLTIzLjE5MiwzOS4wMy01My4zNjQsNjAuNTI1LTg0Ljk1Niw2MC41MjVjLTMxLjU5NywwLTYxLjc3MS0yMS40OTQtODQuOTY2LTYwLjUyMyAgICBjLTI0LjM0Mi00MC45NjEtMzcuNzQ4LTk1LjY3MS0zNy43NDgtMTU0LjA0OVYyNS4xMTJjMC0wLjc4LDAuNjM0LTEuNDEzLDEuNDEyLTEuNDEzaDI0Mi41OTFjMC43OCwwLDEuNDE0LDAuNjM0LDEuNDE0LDEuNDEzICAgIFY4MS44MDN6IE00NTEuMzQ4LDc1LjE5MmMtNi43MDIsNDEuMjA4LTI5LjA3NCw3OC41MS02MS41NjksMTA0LjE5MWM4LjI2OC0zMC4yODMsMTIuNjMxLTYzLjM5NSwxMi42MzEtOTcuNThWNjAuMDAxaDM1Ljc3MyAgICBjMy45MzgsMCw3LjY2LDEuNzIzLDEwLjIxNCw0LjcyNkM0NTAuOTE1LDY3LjY4OCw0NTEuOTYzLDcxLjQwNSw0NTEuMzQ4LDc1LjE5MnoiIGZpbGw9IiNGRkRBNDQiLz4KCTwvZz4KPC9nPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik0zMjcuOTQxLDEyMS42NThjLTEuMzk1LTQuMjg4LTUuMTAzLTcuNDE0LTkuNTY2LTguMDY0bC0zNS43NTgtNS4xOTZsLTE1Ljk5MS0zMi40MDIgICAgYy0xLjk5Ny00LjA0NC02LjExNi02LjYwNS0xMC42MjYtNi42MDVjLTQuNTExLDAtOC42MywyLjU2MS0xMC42MjYsNi42MDVsLTE1Ljk5MSwzMi40MDJsLTM1Ljc1OCw1LjE5NiAgICBjLTQuNDY0LDAuNjQ4LTguMTcyLDMuNzc1LTkuNTY2LDguMDY1Yy0xLjM5Myw0LjI5MS0wLjIzMSw4Ljk5OSwyLjk5OSwxMi4xNDhsMjUuODc1LDI1LjIyMWwtNi4xMDksMzUuNjEzICAgIGMtMC43NjMsNC40NDYsMS4wNjQsOC45MzgsNC43MTQsMTEuNTljMy42NDgsMi42NTEsOC40ODcsMywxMi40NzksMC45MDJMMjU2LDE5MC4zMmwzMS45ODIsMTYuODEzICAgIGMxLjczNCwwLjkxMSwzLjYyNywxLjM2LDUuNTEyLDEuMzZjMi40NTYsMCw0LjkwMi0wLjc2Myw2Ljk2Ni0yLjI2M2MzLjY1LTIuNjUyLDUuNDc3LTcuMTQ0LDQuNzE0LTExLjU5bC02LjEwOS0zNS42MTMgICAgbDI1Ljg3NS0yNS4yMjFDMzI4LjE3MiwxMzAuNjU4LDMyOS4zMzQsMTI1Ljk0OSwzMjcuOTQxLDEyMS42NTh6IE0yNzguMDY0LDE0Ni40MDVjLTIuNzkzLDIuNzIyLTQuMDY4LDYuNjQ0LTMuNDA4LDEwLjQ4OSAgICBsMy4xMDIsMTguMDlsLTE2LjI0NS04LjU0MWMtMS43MjUtMC45MDgtMy42Mi0xLjM2LTUuNTE0LTEuMzZjLTEuODk0LDAtMy43ODgsMC40NTQtNS41MTQsMS4zNmwtMTYuMjQ1LDguNTQxbDMuMTAyLTE4LjA5ICAgIGMwLjY2LTMuODQ0LTAuNjE1LTcuNzY2LTMuNDA4LTEwLjQ4OWwtMTMuMTQxLTEyLjgxbDE4LjE2Mi0yLjY0YzMuODU5LTAuNTYsNy4xOTYtMi45ODUsOC45MjItNi40ODJsOC4xMjMtMTYuNDU4bDguMTIyLDE2LjQ1OCAgICBjMS43MjcsMy40OTcsNS4wNjIsNS45MjEsOC45MjIsNi40ODJsMTguMTYyLDIuNjRMMjc4LjA2NCwxNDYuNDA1eiIgZmlsbD0iI0ZGREE0NCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" />
                      </paper-button>
                      <paper-tooltip for="id_{{card.id}}_{{kudo.id}}" position="top" style="max-width:100px;">{{kudo.title}}<br>{{kudo.description}}</paper-tooltip>
                    </template>
                  </template>
                  <template is="dom-if" if="{{withStars}}">
                    <div class="valoracion-star">
                      <star-rating stars="{{numStars}}" id="star_{{card.id}}" on-click="_putStars"></star-rating>
                      {{getRatingCardUser(card.block,card.id)}}
                    </div>
                  </template>
                </div>
              </div>
            </paper-card>
          </template>
        </iron-collapse>
      </paper-card>
    </template>
    <paper-dialog id="feedback" >
      <h2 id="titleFeedback">Quick feedback for:</h2>
      <paper-textarea id="txtFeedback" label="Write your feedback..."></paper-textarea>
      <div class="buttons">
        <paper-button id="btnFeedback" on-click="sendFeedback" autofocus>Send</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>
    <paper-toast id="toastAlert" text="Thanks for your feedback"></paper-toast>
    
    <paper-dialog id="commentDialog">
      <h2 id="commentDialogTitle">Comments</h2>
      <paper-dialog-scrollable>
        <ul>
          <div id="comments" style="text-align: left;"></div>  
        </ul>
        
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>OK</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
      Polymer({
        is: 'kudos-cards',
        properties:{
          activeEvent     : {type:String, notify:true},
          user            : {type:Object, notify:true},
          userFirstName   : {type:String, notify:true},
          userEmail       : {type:String, notify:true},
          userName        : {type:String, notify:true},
          userPicture     : {type:String, notify:true},
          error           : {type:Object, value:null, notify:true },
          cards           : {type:Array, notify:true},
          blocks          : {type:Array, notify:true},
          kudos           : {type:Array, notify:true},
          withKudos       : {type:Boolean, value:false, notify:true},
          withFeedback    : {type:Boolean, value:false, notify:true},
          withStars       : {type:Boolean, value:false, notify:true},
          numStars        : {type:Number, notify:true},
          maxKudos        : {type:Number, notify:true},
        },
        unCollapse: function(e) {
          if(this.$$('#clp_'+e.target.dataset.args)){
            this.$$('#clp_'+e.target.dataset.args).toggle();
          }
        },
        getKudos:function(){
          var self = this;
          firebase.database().ref(this.activeEvent + '/kudos').once('value').then(function(snapshot) {
            self.kudos = [];
            snapshot.forEach(function(child) {
              var kudo = child.val();
              kudo.id=child.key;
              self.push('kudos', kudo);
            });
            });
        },
        getBlocks:function(){
          var ref = firebase.database().ref(this.activeEvent + "/blocks");
          var self = this;
          ref.once("value").then(function(snapshot) {
            self.blocks = [];
            snapshot.forEach(function(child) {
              var block = child.val();
              block.id  = child.key;
              self.push('blocks', block);
            });
          });
        },
        _getCards:function(block){
          this.cards = [];
          self = this;
          for (var card in block.cards) {
            var newCard = { id:card, title:block.cards[card].title, description:block.cards[card].description,
              leader:block.cards[card].leader, color:block.cards[card].color, withChat:block.cards[card].withChat, 
              linkLabel:block.cards[card].linkLabel, linkValue:block.cards[card].linkValue, kpi:block.cards[card].kpi, 
              sdacode: block.cards[card].sdacode, mvp: block.cards[card].mvp};
            //parameters
            newCard.objetivo        =block.cards[card].parameters.objetivo;
            newCard.detalles        =block.cards[card].parameters.detalles;
            newCard.metrica         =block.cards[card].parameters.metrica;
            newCard.customer        =block.cards[card].parameters.customer;
            newCard.canal           =block.cards[card].parameters.canal;
            newCard.ambiente        =block.cards[card].parameters.ambiente;
            newCard.ambiente_fecha  =block.cards[card].parameters.ambiente_fecha;
            newCard.tiempo          =block.cards[card].parameters.tiempo;
            newCard.participantes   =block.cards[card].parameters.participantes;
            newCard.diferencias     =block.cards[card].parameters.diferencias;
            newCard.limitaciones    =block.cards[card].parameters.limitaciones;
            newCard.marketing       =block.cards[card].parameters.marketing;
            newCard.block           =block.id;
            self.push('cards', newCard);
          }
          return this.cards;
        },
        openBot:function(e){
          var btnCard = Polymer.dom(e).localTarget;
          this.fire('showChatbot', btnCard);
        },
        openModal:function(e){
          var btnCard = Polymer.dom(e).localTarget;
          var card = btnCard.data;
          var self=this;
          this.$.txtFeedback.value="";
          this.$.btnFeedback.data=card;
          this.$.titleFeedback.innerHTML="Quick feedback for:<br>" + card.title;
          this.$.feedback.open();
          var ref = firebase.database().ref(this.activeEvent + "/users/" + this.userEmail+ "/feedback/"+ card.block +"/" + card.id + "/comment");
          ref.once('value').then(function(snapshot) {
            var msg="";
            if(snapshot.val()!=null){
              msg=snapshot.val().message;
            }
            self.$.txtFeedback.value=msg;
          });
        },
        sendFeedback:function(){
          var db = firebase.database();
          var card=this.$.btnFeedback.data;
          var msg=this.$.txtFeedback.value;
          if(msg.trim().length==0){this.$.feedback.close();return;}
          var ref = db.ref(this.activeEvent + "/users/" + this.userEmail + "/feedback");
          var postData = {
            message: msg
          };
          var updates = {};
          updates["/"+ card.block + "/" + card.id + "/comment"] = postData;
          ref.update(updates);
          this.$.txtFeedback.value="";
          this.$.feedback.close();
          this.$.toastAlert.open();
        },    
        getKudosUser:function(idBlock,idCard,idKudo){
          self=this;
          var ref = firebase.database().ref(this.activeEvent + "/users/" + this.userEmail + "/kudos/"+ idBlock +"/" + idCard + "/" + idKudo);
          ref.once('value').then(function(snapshot) {
            if(snapshot.val()!=null){
                self.$$('#id_' +idCard +'_' +idKudo).active=snapshot.val();
            }
          });
        },
        getRatingCardUser:function(idBlock,idCard){
          self=this;
          var ref = firebase.database().ref(this.activeEvent + "/users/" + this.userEmail + "/feedback/"+ idBlock + "/" + idCard + "/rating");
          ref.once('value').then(function(snapshot) {
            var numStars=0;
            if(snapshot.val()!=null){
              numStars=snapshot.val();
              self.stars=numStars;
            }
            self.$$('#star_' +idCard).rate=numStars;
          });
        },
        _assess:function(e) {
          var kudoSeleccionado = e.model['__data__'];
          var idKudo = kudoSeleccionado.kudo.id;
          var idCard = kudoSeleccionado.card.id;
          var idBlock = kudoSeleccionado.card.block;
          var idBtnKudo=this.$$('#id_' +idCard +'_' +idKudo);
          var voto = 1;
          if (!idBtnKudo.active){ //botón inactivo
            voto = -1;
          }
          var refControl = firebase.database().ref(this.activeEvent +'/users').child(this.userEmail+"/kudos");
          if(voto > 0) {
            var updates = {};
            updates["/" + idBlock + "/" + idCard + "/" + idKudo] = true;
            refControl.update(updates);

            for (index = 0; index < this.blocks[idBlock].length; ++index) {
                console.log(this.blocks[idBlock][index]);
            }

            this.blocks[idBlock].cards.forEach(function(entry) {
                this.$$('#id_' +idBlock + '_' +  kudo.id).active=false;
            });
            //self.$$('#id_' +idBlock).active=false;
          } else {
            firebase.database().ref(this.activeEvent +'/users').child(this.userEmail).child("/kudos/"+idBlock).child(idCard).child(idKudo).remove();
          }
        },
        _putStars:function(e) {
          var data = e.model['__data__'];
          var idCard = data.card.id;
          var idBlock = data.card.block;
          var ratingCard = this.$$('#star_' + idCard).rate;
          var ref = firebase.database().ref(this.activeEvent + "/users/" + this.userEmail+"/feedback");
          if (ratingCard>0){
            var updates = {};
            updates["/" + idBlock + "/" + idCard + "/rating"] = ratingCard;
            ref.update(updates);
          }else{
            firebase.database().ref(this.activeEvent +'/users').child(this.userEmail).child("/feedback/"+idBlock).child(idCard).child('rating').remove();
          }
        },
        _getComments:function(e){
          var btnComments = Polymer.dom(e).localTarget;
          var card = btnComments.data;
          var self=this;
          var _listado="";
          
          var ref = firebase.database().ref(this.activeEvent + "/blocks/"+  card.block +"/cards/" + card.id + "/comments");
          var self = this;
          console.info(self.activeEvent + "/blocks/" +  card.block + "/cards/" + card.id + "/comments");
          
          ref.once("value").then(function(snapshot) {
            self.$.comments.value="";
            snapshot.forEach(function(child) {
              console.info(child.key);
              console.info(child.val());
              var comment = child.val();
              self.$.comments.value=self.$.comments.value + "<li>" + comment + "</li>";
            });
          });
          self.$.commentDialog.open();
        }
      });
    </script>
</dom-module>
