<dom-module id="kudos-cards">
<link rel="import" href="../css/kudo-style.html">
    <template>
        <style include="cards"></style>
        <img id="imgProfile" class="avatar" src="{{user.photoURL}}">
        Â¡Bienvenido {{user.displayName}}!
        
        <template id="resultList" is="dom-repeat" items="{{blocks}}" as="block">
          <template id="resultList" is="dom-repeat" items="{{_getCards(block)}}" as="card">
          <paper-card class="rate">
            <div class="rate-content">
              <div>
                <div class="rate-header titleProject" style="background-color:{{card.color}}">{{block.title}}</div>
                  <div class="rate-name">
                    <div class="div_middle">
                      {{card.title}} <br> 
                      {{card.description}}
                    </div>
                    <div class="div_feedback">
                      <paper-button class="rate-icon feeback" id="{{card.id}}" data='{{card}}'
                        on-click="openModal">
                        Danos feedback <iron-icon icon="announcement" data='{{card}}'></iron-icon>
                      </paper-button>
                    </div>
                  </div>
              </div>
                <div class="card-actions">
                  <template id="tmtKudo" is="dom-repeat" items="{{kudos}}" as="kudo">
                    <!--{{getKudosUser()}}-->
                    <paper-button class="kudo" toggles  id="{{card.id}}_{{kudo.id}}" on-click="valorar">
                      <iron-icon icon="{{kudo.icon}}"></iron-icon> {{kudo.title}}
                    </paper-button>
                    <paper-tooltip for="{{kudo.id}}" position="top" style="max-width:100px;">{{kudo.title}}<br> {{kudo.description}}</paper-tooltip>
                  </template>
                </div>
          </paper-card>
          </template>
        </template>
        <paper-dialog id="feedback" >
          <h2 id="titleFeedback">Feedback para:</h2>
          <paper-textarea id="txtFeedback" label="Ingresa tu feedback..."></paper-textarea>
          <div class="buttons">
            <paper-button id="btnFeedback" on-click="sendFeedback" autofocus>Enviar</paper-button>
            <paper-button dialog-dismiss>Cancelar</paper-button>
          </div>
        </paper-dialog>
        <paper-toast id="toastAlert" text="Gracias por tu feedback"></paper-toast>
    </template>
    <script>
      Polymer({
        is: 'kudos-cards',
        properties:{
          activeEvent:{
            type: String,
            value:"macroComite4T",
            notify:true
          },
          db: Object,
          user : {type: Object, notify:true},
          userEmail: {type: String, notify:true},
          error:{
            type: Object,
            value:null,
            notify:true
          },
          cards:{
            type: Array,
            notify:true
          },
          blocks:{
            type: Array,
            notify:true
          },
          kudos:{
            type: Array,
            notify:true
          },
        },
        attached:function(){
            console.info(this.user);
            //this.userEmail=this.user.email.toString().replace(/[@.]/g,'_'); 
            this.userEmail="elvis_nizama_bbva_com";
            this.getKudos();
            this.getBlocks();
        },
        ready:function(){
            console.info(this.user);
        },
        getKudos:function(){
          var self = this;
          self.kudos = [];
          firebase.database().ref('eventos/' + this.activeEvent + '/kudos').once('value').then(function(snapshot) {
            snapshot.forEach(function(child) {
              var kudo = child.val();
              kudo.id=child.key;
              self.push('kudos', kudo);
            });
          });
        },
        getCards:function(){
          console.info(this.activeEvent);
          var ref = firebase.database().ref("eventos/" + this.activeEvent + "/blocks");
          var self = this;
          self.cards = [];
          ref.once("value").then(function(snapshot) {
            snapshot.forEach(function(child) {
              var block = child.val();
              var _card={}; 
              for (var card in block.cards) {
                _card.titleBlock=block.title;
                _card.color=block.color;
                _card.description=block.cards[card].description;
                _card.title=block.cards[card].title;
                _card.id=card;
                console.info(_card);
                self.push('cards', _card);
              }
            });
          });
        },
        getBlocks:function(){
          console.info(this.activeEvent);
          var ref = firebase.database().ref("eventos/" + this.activeEvent + "/blocks");
          var self = this;
          self.blocks = [];
          ref.once("value").then(function(snapshot) {
            snapshot.forEach(function(child) {
              var block = child.val();
              self.push('blocks', block);
            });
          });
        },
        _getCards:function(block){
          this.cards=[];
          self=this;
          
          for (var card in block.cards) {
            var _card={}; 
            _card.titleBlock=block.title;
            _card.color=block.color;
            _card.description=block.cards[card].description;
            _card.title=block.cards[card].title;
            _card.id=card;
            console.info(_card);
            self.push('cards', _card);
          }
          return this.cards;
        },
        openModal:function(e){
          var btnCard = Polymer.dom(e).localTarget;
          var card=btnCard.data;
          var self=this;
          this.$.btnFeedback.data=card.id;
          this.$.titleFeedback.innerHTML="Feedback para:<br>" + card.title;
          this.$.feedback.open();
          var ref = firebase.database().ref("eventos/" + this.activeEvent + "/users/" + this.userEmail+ "/"+ card.id + "/comments");
          ref.once('value').then(function(snapshot) {
            var msg="";
            if(snapshot.val()!=null){
              msg=snapshot.val().message;
            }
            self.$.txtFeedback.value=msg; 
          });
        },
        sendFeedback:function(){
          var db = firebase.database();
          var idCard=this.$.btnFeedback.data;
          console.log(idCard);
          var msg=this.$.txtFeedback.value;
          if(msg.trim().length==0){this.$.feedback.close();return;}
          var ref = db.ref("eventos/" + this.activeEvent + "/users/" + this.userEmail);
          var postData = {
            //author: this.userUid,
            message: msg
          };
          //var newPostKey = ref.child('comments').push().key;
          var updates = {};
          
          updates["/" +idCard + "/comments"] = postData;
          ref.update(updates); 
          this.$.txtFeedback.value="";
          this.$.feedback.close();
          this.$.toastAlert.open();
        },
        _valorar:function(e) {
          var kudoSeleccionado = e.model['__data__'];
          var idKudo = kudoSeleccionado.kudo.id;
          var idCard = kudoSeleccionado.card.id;
          var idBtnKudo=this.$$('#' +idCard +'_' +idKudo);
          var voto = 1;
          if (!idBtnKudo.active){
            voto = -1;  
          }
        //   var postRef = firebase.database().ref('/eventos').child(this.activeEvent).child('kudos').child(idKudo);
        //   postRef.transaction(function(votoActual) {
        //     if (votoActual) {
        //       return votoActual+voto;
        //     } else {
        //       return 1;
        //     }
        //   });
          var refControl = firebase.database().ref('/eventos/users').child(this.userEmail).child('kudos').child(this.idCard);
          if(voto > 0) {
            var updates = {};
            updates["/" +idKudo] = true;
            refControl.update(updates); 
          } else {
            firebase.database().ref('/users').child(this._user).child(this.project.id).child('kudos').child(idKudo).remove();
          }
        },
      });
    </script>
</dom-module>