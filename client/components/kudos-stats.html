<dom-module id="kudos-stats">
<link rel="import" href="../css/kudo-style.html">
<template id="tmpkudoStats">
 <style include="cards"></style>
 <style include="stats"></style>
  <div class="card">
    <h3>Resultados del evento</h3>
  </div>
  <paper-tabs selected="{{selected}}">
    <paper-tab>Valoraciones</paper-tab>
    <paper-tab>Agradecimientos</paper-tab>
    <paper-tab>Feedback</paper-tab>
  </paper-tabs>

  <iron-pages selected="{{selected}}">
    <div class="resultFeedback">
      <h3>Ranking general</h3>
      <template is="dom-repeat" items="{{sortedCards}}" as="sortCard">
        <div width="100%" style="text-align:left !important;margin-top:3px;">
          <div style="display:inline-block;width:5%">
            <img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTEuOTk5IDUxMS45OTkiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMS45OTkgNTExLjk5OTsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHdpZHRoPSIyNHB4IiBoZWlnaHQ9IjI0cHgiPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik00NjYuNDUsNDkuMzc0Yy03LjA2NS04LjMwOC0xNy4zNjgtMTMuMDcxLTI4LjI2Ny0xMy4wNzFINDAyLjQxdi0xMS4xOUM0MDIuNDEsMTEuMjY2LDM5MS4xNDMsMCwzNzcuMjk3LDBIMTM0LjcwNSAgICBjLTEzLjg0OCwwLTI1LjExMiwxMS4yNjYtMjUuMTEyLDI1LjExMnYxMS4xOUg3My44MTZjLTEwLjg5OSwwLTIxLjIwMyw0Ljc2NC0yOC4yNjcsMTMuMDcxICAgIGMtNi45OTIsOC4yMjEtMTAuMDE0LDE5LjAxOS04LjI4OSwyOS42MjRjOS40LDU3LjgsNDUuNzc1LDEwOC44NjMsOTcuNCwxMzYuODcyYzQuNzE3LDExLjM0MSwxMC4wNTksMjIuMDgzLDE2LjAwOCwzMi4wOTEgICAgYzE5LjAwMiwzMS45NzUsNDIuNjI1LDU0LjA3Myw2OC42MjcsNjQuNzZjMi42MzUsMjYuNjQ0LTE1LjA5NCw1MS44ODUtNDEuNzk0LDU3LjljLTAuMDU3LDAuMDEzLTAuMDk3LDAuMDMzLTAuMTUzLDAuMDQ2ICAgIGMtNS4yMTEsMS4yNDUtOS4wOSw1LjkyMS05LjA5LDExLjUxM3Y1NC4zNjNoLTIxLjk4NmMtMTkuNjAyLDAtMzUuNTQ5LDE1Ljk0Ny0zNS41NDksMzUuNTQ5djI4LjA1OCAgICBjMCw2LjU0NSw1LjMwNSwxMS44NSwxMS44NSwxMS44NUgzOTAuNTZjNi41NDUsMCwxMS44NS01LjMwNSwxMS44NS0xMS44NXYtMjguMDU4YzAtMTkuNjAyLTE1Ljk0Ny0zNS41NDktMzUuNTQ5LTM1LjU0OWgtMjEuOTg4ICAgIFYzODIuMThjMC01LjYwMy0zLjg5My0xMC4yODYtOS4xMTgtMTEuNTJjLTAuMDQ5LTAuMDEyLTAuMDk2LTAuMDI4LTAuMTQ1LTAuMDRjLTI2LjkwMi02LjA1NS00NC42NjQtMzEuNTUtNDEuNzUyLTU4LjM5NCAgICBjMjUuNTQ4LTEwLjg2LDQ4Ljc1Ny0zMi43NjEsNjcuNDc5LTY0LjI2NGM1Ljk0OS0xMC4wMDksMTEuMjktMjAuNzUyLDE2LjAwOC0zMi4wOTVjNTEuNjIyLTI4LjAxLDg3Ljk5NS03OS4wNzIsOTcuMzk1LTEzNi44NyAgICBDNDc2LjQ2NSw2OC4zOTIsNDczLjQ0Myw1Ny41OTUsNDY2LjQ1LDQ5LjM3NHogTTYwLjY1Miw3NS4xOTJjLTAuNjE2LTMuNzg3LDAuNDMxLTcuNTA0LDIuOTQ5LTEwLjQ2NiAgICBjMi41NTUtMy4wMDQsNi4yNzctNC43MjYsMTAuMjE0LTQuNzI2aDM1Ljc3N3YyMS44MDJjMCwzNC4xODYsNC4zNjMsNjcuMywxMi42MzIsOTcuNTgzICAgIEM4OS43MjgsMTUzLjcwNiw2Ny4zNTQsMTE2LjQwMyw2MC42NTIsNzUuMTkyeiBNMzY2Ljg2MSw0NjAuMjQzYzYuNTM0LDAsMTEuODUsNS4zMTYsMTEuODUsMTEuODV2MTYuMjA4SDEzNC40MjJ2LTE2LjIwOCAgICBjMC02LjUzNCw1LjMxNi0xMS44NSwxMS44NS0xMS44NUgzNjYuODYxeiBNMzIxLjE3MywzOTQuMDN2NDIuNTEzSDE5MS45NlYzOTQuMDNIMzIxLjE3M3ogTTIyMy4wMzcsMzcwLjMzMSAgICBjMi45MjktMy4yMjQsNS42MDctNi43MTksOC4wMDItMTAuNDZjNy44OTctMTIuMzM5LDEyLjA0Mi0yNi4zNTcsMTIuMjI4LTQwLjY3NGM0LjIwOSwwLjU3Myw4LjQ1NywwLjg4LDEyLjc0MSwwLjg4ICAgIGM0LjY2MSwwLDkuMjc5LTAuMzU4LDEzLjg1Mi0xLjAzNmMwLjI3LDE5LjIzOSw3Ljc1OCwzNy40NSwyMC4zNDksNTEuMjg5SDIyMy4wMzd6IE0zNzguNzA5LDgxLjgwMyAgICBjMCw1OC4zNzktMTMuNDA2LDExMy4wODktMzcuNzQ3LDE1NC4wNDljLTIzLjE5MiwzOS4wMy01My4zNjQsNjAuNTI1LTg0Ljk1Niw2MC41MjVjLTMxLjU5NywwLTYxLjc3MS0yMS40OTQtODQuOTY2LTYwLjUyMyAgICBjLTI0LjM0Mi00MC45NjEtMzcuNzQ4LTk1LjY3MS0zNy43NDgtMTU0LjA0OVYyNS4xMTJjMC0wLjc4LDAuNjM0LTEuNDEzLDEuNDEyLTEuNDEzaDI0Mi41OTFjMC43OCwwLDEuNDE0LDAuNjM0LDEuNDE0LDEuNDEzICAgIFY4MS44MDN6IE00NTEuMzQ4LDc1LjE5MmMtNi43MDIsNDEuMjA4LTI5LjA3NCw3OC41MS02MS41NjksMTA0LjE5MWM4LjI2OC0zMC4yODMsMTIuNjMxLTYzLjM5NSwxMi42MzEtOTcuNThWNjAuMDAxaDM1Ljc3MyAgICBjMy45MzgsMCw3LjY2LDEuNzIzLDEwLjIxNCw0LjcyNkM0NTAuOTE1LDY3LjY4OCw0NTEuOTYzLDcxLjQwNSw0NTEuMzQ4LDc1LjE5MnoiIGZpbGw9IiNGRkRBNDQiLz4KCTwvZz4KPC9nPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik0zMjcuOTQxLDEyMS42NThjLTEuMzk1LTQuMjg4LTUuMTAzLTcuNDE0LTkuNTY2LTguMDY0bC0zNS43NTgtNS4xOTZsLTE1Ljk5MS0zMi40MDIgICAgYy0xLjk5Ny00LjA0NC02LjExNi02LjYwNS0xMC42MjYtNi42MDVjLTQuNTExLDAtOC42MywyLjU2MS0xMC42MjYsNi42MDVsLTE1Ljk5MSwzMi40MDJsLTM1Ljc1OCw1LjE5NiAgICBjLTQuNDY0LDAuNjQ4LTguMTcyLDMuNzc1LTkuNTY2LDguMDY1Yy0xLjM5Myw0LjI5MS0wLjIzMSw4Ljk5OSwyLjk5OSwxMi4xNDhsMjUuODc1LDI1LjIyMWwtNi4xMDksMzUuNjEzICAgIGMtMC43NjMsNC40NDYsMS4wNjQsOC45MzgsNC43MTQsMTEuNTljMy42NDgsMi42NTEsOC40ODcsMywxMi40NzksMC45MDJMMjU2LDE5MC4zMmwzMS45ODIsMTYuODEzICAgIGMxLjczNCwwLjkxMSwzLjYyNywxLjM2LDUuNTEyLDEuMzZjMi40NTYsMCw0LjkwMi0wLjc2Myw2Ljk2Ni0yLjI2M2MzLjY1LTIuNjUyLDUuNDc3LTcuMTQ0LDQuNzE0LTExLjU5bC02LjEwOS0zNS42MTMgICAgbDI1Ljg3NS0yNS4yMjFDMzI4LjE3MiwxMzAuNjU4LDMyOS4zMzQsMTI1Ljk0OSwzMjcuOTQxLDEyMS42NTh6IE0yNzguMDY0LDE0Ni40MDVjLTIuNzkzLDIuNzIyLTQuMDY4LDYuNjQ0LTMuNDA4LDEwLjQ4OSAgICBsMy4xMDIsMTguMDlsLTE2LjI0NS04LjU0MWMtMS43MjUtMC45MDgtMy42Mi0xLjM2LTUuNTE0LTEuMzZjLTEuODk0LDAtMy43ODgsMC40NTQtNS41MTQsMS4zNmwtMTYuMjQ1LDguNTQxbDMuMTAyLTE4LjA5ICAgIGMwLjY2LTMuODQ0LTAuNjE1LTcuNzY2LTMuNDA4LTEwLjQ4OWwtMTMuMTQxLTEyLjgxbDE4LjE2Mi0yLjY0YzMuODU5LTAuNTYsNy4xOTYtMi45ODUsOC45MjItNi40ODJsOC4xMjMtMTYuNDU4bDguMTIyLDE2LjQ1OCAgICBjMS43MjcsMy40OTcsNS4wNjIsNS45MjEsOC45MjIsNi40ODJsMTguMTYyLDIuNjRMMjc4LjA2NCwxNDYuNDA1eiIgZmlsbD0iI0ZGREE0NCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" />
            {{sortCard.numVotes}}
          </div>
          <div style="vertical-align:middle;display:inline-block;width:80%">{{sortCard.titleBlock}} &gt; {{sortCard.title}}</div>
        </div>
      </template>
    </div>

    <div class="resultFeedback">
      <h3>Ranking por Votación</h3>
      <span id="numUsers">(Número de usuarios: {{numUsers}})</span>
      <template is="dom-repeat" items="{{users}}" as="user">
        <div>
          <div class="personItem" tabindex$="[[tabIndex]]">
            <iron-image class="avatar" sizing="contain" src="[[user.picture]]"></iron-image>
            <div class="pad">
              <div class="primary">[[user.name]]</div>
              <address>
                <div class="userSection">Feedbacks: [[user.numFeedback]]</div>
                <template is="dom-if" if="{{withStars}}">
                  <div class="userSection">Stars: [[user.numStars]]</div>
                </template>
              </address>
            </div>
          </div>
        </div>
      </template>
    </div>

    <div class="resultFeedback">
      <div>
        <paper-button id="btnReload" toggles on-click="reloadFeedback" class="reload">
          <iron-icon icon="icons:autorenew"></iron-icon> Reload  
        </paper-button>
        <h3>Revisa cada proyecto (click)</h3>
      </div>
      <template is="dom-repeat" items="{{cards}}" as="card">
        <div class="heading" on-click="toggleRanking" data="{{card.id}}" style$="background:{{card.color}}">
          {{card.titleBlock}} &gt; {{card.title}}
        </div>
        <iron-collapse id="cl_{{card.id}}">
          <div class="content">
            <template is="dom-if" if="{{withStars}}">
              <div id="st_{{card.id}}">
                <div><div class="userSection" style="vertical-align:top;"><b>Valoración</b> </div><div class="userSection2"> {{card.totalRating}} stars / {{card.usersRating}} users = {{card.averageRating}} </div></div>
              </div>
            </template>
            <template is="dom-if" if="{{withKudos}}">
              <div><span><b>Kudos</b></span></div>
              <div>{{cards.numVotes}}</div>
            </template>
            <template is="dom-if" if="{{withFeedback}}">
              <div><span><b>Feedback</b></span>
                <div id="fb_{{card.id}}">
                  <template is="dom-repeat" items="{{_getComments(card.comments)}}" as="comment">
                  {{comment}}
                  </template>
                </div>
              </div>
            </template>
          </div>
        </iron-collapse>
      </template>
    </div>
    
  </iron-pages>
</template>
<script>
 Polymer({
    is: 'kudos-stats',
    properties: {
      activeEvent   : { type: String, notify:true },
      cards         : { type: Array, notify:true },
      users         : { type: Array, notify:true },
      listUsers     : { type: Object, notify:true },
      numUsers      : { type: String, notify:true },
      selected      : { value: 0 },
      display       : { value: "block" },
      sortedCards   : { type: Array, notify:true },
      withKudos     : {type:Boolean, value:false, notify:true},
      withFeedback  : {type:Boolean, value:false, notify:true},
      withStars     : {type:Boolean, value:false, notify:true},
      arrComments   : { type: Array, notify:true},
    },
    getCards:function(){
      var ref = firebase.database().ref(this.activeEvent + "/blocks");
      var self = this;
      self.cards = [];
      ref.once('value',function(snapshot) {
        snapshot.forEach(function(child) {
          var block = child.val();
          for (var idCard in block.cards) {
            var card        = {};
            card            = block.cards[idCard];
            card.id         = idCard;
            card.titleBlock = block.title;
            card.color      = block.color;
            if (block.cards[idCard].numVotes == undefined){
              card.totalRating =0;
              card.usersRating =0;
            }else{
              card.totalRating =block.cards[idCard].numVotes;
              //card.usersRating =block.cards[idCard].statRating.users;
              card.usersRating =block.cards[idCard].numVotes;
              card.averageRating=0;
              if (card.usersRating > 0 ){
                card.averageRating=Number(card.totalRating) / Number(card.usersRating);
              }
            }
            // card.statKudos={}
            
            // if(block.cards[idCard].statKudos != undefined){
            //   console.info(block.cards[idCard].statKudos);
            //   //card.statKudos= block.cards[idCard].statKudos;
            //   for(var stat in block.cards[idCard].statKudos){
            //     console.info('BLOQUE : ' + block.cards[idCard].statKudos[stat]);
            //   }
            // }
            
            //console.info(card.comments);
            // if(card.comments == undefined){
            //   card.comments={};
            // }else{
            //   card.comments=block.cards[idCard].comments;
            // }
            self.push('cards', card);
          }
          self.sortedCards = self.cards;
          self.sortedCards.sort(function(a,b) {
            return (a.totalRating > b.totalRating) ? -1 : ((b.totalRating > a.totalRating) ? 1 : 0);} );
          
        });
      });
    },
    _getComments:function(comments){
      if (comments!=undefined){
        this.arrComments=[];
        for (var comment in comments) {
          this.push("arrComments",comments[comment].message);
        }
        return this.arrComments;
      }
    },
    getRanking:function() {
      var self=this;
      firebase.database().ref(this.activeEvent +'/users').once('value',function(snapshot) {
        var users = snapshot.val();
        self.set('listUsers',users);
        var numUsers=0;
        self.users=[];
        for (var user in users) {
          var _user={};
          numUsers++;
          _user.name=users[user].profile.name;
          _user.picture=users[user].profile.picture;
          var numKudos=0;
          var numFeedback=0;
          var numStars=0;
          //console.log('user: ' + user);
          for (var block in users[user].feedback) {
            //console.info('block: ' + block);
            for(var card in users[user].feedback[block]){
              var vote = users[user].feedback[block][card];
              for (var prop in vote) {
                if (prop == 'comment') {
                  for (var commentProps in users[user].feedback[block][card][prop]) {
                    if (commentProps == 'message') {
                      var message = users[user].feedback[block][card][prop][commentProps];
                      if (message.toString().trim().length>1) {
                        numFeedback++;
                      }
                    }
                  }
                } else if (prop == 'kudos') {
                  var kudos = users[user].feedback[block][card]['kudos'];
                  for (var kudo in kudos){
                    if (kudos[kudo]){ numKudos++; }
                  }
                }else if(prop == 'rating'){
                  //console.log("rating: " + users[user].feedback[block][card]['rating']);
                  var rating =0;
                  if (users[user].feedback[block][card]['rating'] == null){ rating = 0;
                  } else { rating = users[user].feedback[block][card]['rating']; }
                  numStars = numStars + rating;
                }
              }
            }
          }
          _user.numKudos=numKudos;
          _user.numFeedback=numFeedback;
          _user.numStars=numStars;
          self.push('users',_user);
        }
        self.numUsers=numUsers;
        self.users.sort(function(a,b) {
        return (a.numFeedback > b.numFeedback) ? -1 : ((b.numFeedback > a.numFeedback) ? 1 : 0);} );
        //self.users.sort(function(a,b) {
        //  return (a.numStars > b.numStars) ? -1 : ((b.numStars > a.numStars) ? 1 : 0);} );
      });

    },
    findObjectByKey:function(array, key, value) {
      for (var i = 0; i < array.length; i++) {
          if (array[i][key] === value) {
              return array[i];
          }
      }
      return null;
    },
    toggleRanking:function(e) {
      var idCard=Polymer.dom(e).localTarget.data;
      this.$$('#cl_' +idCard).toggle();
    },
    reloadFeedback:function(e) {
      this.getCards();
      this.getRanking();
    }
  });
</script>
</dom-module>
